<html>
<head>
    <script language="javascript">
        var socket;
        var lastEv;
        var image;
        window.onload = function() {
            image = document.getElementById("image");
            socket = new WebSocket('ws://127.0.0.1:12345');
            socket.onopen = function(ev) {
                //console.log("open: " + ev.currentTarget.URL);
            }
            socket.onerror = function(err) {
                console.log("error: " + err);
            }
            socket.onmessage = function(ev) {
                lastEv = ev;
            }

            function mkMouseEvent(ev, type) {
                return JSON.stringify({'event_type': type, 'x': ev.offsetX, 'y': ev.offsetY, 'button': ev.button, 'buttons': ev.buttons, 'altKey': ev.altKey, 'ctrlKey': ev.ctrlKey, 'shiftKey': ev.shiftKey})
            }
            function onMousePress(ev) {
                //console.log(ev)
                socket.send(mkMouseEvent(ev, 'mousePress'))
            }
            function onMouseRelease(ev) {
                //console.log(ev)
                socket.send(mkMouseEvent(ev, 'mouseRelease'))
            }
            function onMouseMove(ev) {
                //console.log(ev)
                socket.send(mkMouseEvent(ev, 'mouseMove'))
            }
            image.addEventListener('mousedown', onMousePress, false);
            image.addEventListener('mouseup', onMouseRelease, false);
            image.addEventListener('mousemove', onMouseMove, false);
            image.ondragstart = function() { return false; };
            image.oncontextmenu = function() { return false; };
        }
            
        function updateImage() {
            if( lastEv == undefined ) {
                return
            }
            url = URL.createObjectURL(lastEv.data);
            image.src = url;
            lastEv = undefined;
        }
        
        window.setInterval(updateImage, 30)
        
    </script>
</head>
<body>
    <img id="image">
</body>
</html>